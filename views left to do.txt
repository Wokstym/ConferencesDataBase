/****** Object:  View [dbo].[ConferenceDayPayingInfo]    Script Date: 2014-01-31 10:42:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[ConferenceDayPayingInfo]
AS
SELECT        CB.booking_id, C.conference_id, CB.conference_day_id, CB.client_id, CB.booking_date, CB.places_reserved AS 'Places booked', COUNT(CR.reservation_id) 
                         AS [Places assigned], COUNT(S.participant_id) AS Students, CAST(PRI.price * ((COUNT(CR.reservation_id) - COUNT(S.participant_id)) + COUNT(S.participant_id) 
                         * PRI.student_discount) AS numeric(10, 2)) AS 'Conference day act price', dbo.GetPriceStageForDate(CB.booking_date, CB.conference_day_id) 
                         * CB.places_reserved AS 'Conference day max price', ISNULL(WI.act_price, 0) AS 'Workshops act price', ISNULL(WI.up_price, 0) AS 'Workshops max price'
FROM            dbo.Conference_day_bookings AS CB INNER JOIN
                         dbo.Conference_day AS CD ON CB.conference_day_id = CD.conference_day_id INNER JOIN
                         dbo.Conferences AS C ON CD.conference_id = C.conference_id LEFT OUTER JOIN
                         dbo.Conference_day_reservations AS CR ON CB.booking_id = CR.conference_day_booking_id LEFT OUTER JOIN
                         dbo.Students AS S ON CR.participant_id = S.participant_id AND DATEDIFF(day, C.start_day, S.expiration_date) >= 0 INNER JOIN
                         dbo.Prices_info AS PRI ON PRI.info_id = dbo.GetPriceInfoIdForDate(CB.booking_date, CB.conference_day_id) LEFT OUTER JOIN
                             (SELECT        [Booking id] AS conference_day_booking, SUM([Price for reserved places]) AS act_price, SUM([Price at the most]) AS up_price
                               FROM            dbo.WorkshopBookingPayingInfo
                               GROUP BY [Booking id]) AS WI ON CB.booking_id = WI.conference_day_booking
GROUP BY CB.booking_id, CB.conference_day_id, CB.client_id, CB.booking_date, CB.places_reserved, PRI.price, PRI.student_discount, C.conference_id, WI.act_price, 
                         WI.up_price

GO
/****** Object:  View [dbo].[ConferencePayingInfo]    Script Date: 2014-01-31 10:42:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[ConferencePayingInfo]
AS
SELECT        client_id, conference_id, CAST(SUM([Conference day act price]) + SUM([Workshops act price]) AS numeric(10, 2)) AS 'Act price to pay for conference', 
                         CAST(SUM([Conference day max price]) + SUM([Workshops max price]) AS numeric(10, 2)) AS 'Max price to pay for conference'
FROM            dbo.ConferenceDayPayingInfo
GROUP BY client_id, conference_id

GO
/****** Object:  View [dbo].[PaymentsDiffInfo]    Script Date: 2014-01-31 10:42:24 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW [dbo].[PaymentsDiffInfo]
AS
SELECT        P.booking_id AS [Conference day booking id], CAST(SUM(P.amount) AS numeric(10, 2)) AS [Paid money], 
                         CAST(CB.[Conference day act price] + CB.[Workshops act price] AS numeric(10, 2)) AS 'Act price to pay for booking', 
                         CAST(CB.[Conference day max price] + CB.[Workshops max price] AS numeric(10, 2)) AS 'Max price to pay for booking'
FROM            dbo.Payments AS P INNER JOIN
                         dbo.ConferenceDayPayingInfo AS CB ON P.booking_id = CB.booking_id
GROUP BY CB.[Conference day act price] + CB.[Workshops act price], CB.[Conference day max price] + CB.[Workshops max price], P.booking_id

